<script>
let map, originMarker, destinationMarker, geocoder, directionsService, directionsRenderer, sevillaCircle;
window.distanciaKm = 0;

const SEVILLA_CENTER = { lat: 37.3980, lng: -5.9650 };
const SEVILLA_RADIUS_M = 6500; // 6,5 km

// Bases por nivel (siempre en orden de menor a mayor)
const BASES = {
  porte: 35,
  porte_cyd: 60,
  mudanza_peq: 90,
  mudanza_comp: 140
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), { center: SEVILLA_CENTER, zoom: 12 });
  geocoder = new google.maps.Geocoder();
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

  // C√≠rculo Sevilla Capital (tarifa reducida)
  sevillaCircle = new google.maps.Circle({
    strokeColor: '#007BFF', strokeOpacity: 0.8, strokeWeight: 2,
    fillColor: '#007BFF', fillOpacity: 0.15, map, center: SEVILLA_CENTER,
    radius: SEVILLA_RADIUS_M, clickable: false
  });

  // Click en mapa: A -> B -> reset
  map.addListener("click", (e) => {
    if (!originMarker) {
      originMarker = new google.maps.Marker({ position: e.latLng, map, label: "A" });
      geocodePosition(e.latLng, "origen");
    } else if (!destinationMarker) {
      destinationMarker = new google.maps.Marker({ position: e.latLng, map, label: "B" });
      geocodePosition(e.latLng, "destino");
      calcularDistancia();
    } else {
      resetRuta();
    }
    actualizarPrecio();
  });

  // Escribir direcciones tambi√©n marca en el mapa
  document.getElementById("origen").addEventListener("change", () => geocodeAddress("origen"));
  document.getElementById("destino").addEventListener("change", () => geocodeAddress("destino"));

  // Recalcular precio al cambiar opciones
  document.querySelectorAll('.option').forEach(op => op.addEventListener('change', actualizarPrecio));

  // Recalcular peso si cambian cantidades o peso manual
  ["armarios","cajas","bultos","sofas","camaMatrimonio","camaIndividual","pesoManual"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', actualizarPrecio);
  });
}

function geocodePosition(latlng, inputId) {
  geocoder.geocode({ location: latlng }, (results, status) => {
    if (status === "OK" && results[0]) {
      document.getElementById(inputId).value = results[0].formatted_address;
    }
  });
}

function geocodeAddress(inputId) {
  const address = document.getElementById(inputId).value;
  if (!address) return;
  geocoder.geocode({ address }, (results, status) => {
    if (status === "OK" && results[0]) {
      if (inputId === "origen") {
        if (originMarker) originMarker.setMap(null);
        originMarker = new google.maps.Marker({ position: results[0].geometry.location, map, label: "A" });
      } else {
        if (destinationMarker) destinationMarker.setMap(null);
        destinationMarker = new google.maps.Marker({ position: results[0].geometry.location, map, label: "B" });
      }
      map.setCenter(results[0].geometry.location);
      if (originMarker && destinationMarker) calcularDistancia();
      actualizarPrecio();
    }
  });
}

function insideSevilla(latLng){
  const center = new google.maps.LatLng(SEVILLA_CENTER.lat, SEVILLA_CENTER.lng);
  const dist = google.maps.geometry.spherical.computeDistanceBetween(latLng, center);
  return dist <= SEVILLA_RADIUS_M;
}

function calcularDistancia() {
  if (!originMarker || !destinationMarker) return;
  const request = {
    origin: originMarker.getPosition(),
    destination: destinationMarker.getPosition(),
    travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, (result, status) => {
    if (status === "OK") {
      directionsRenderer.setDirections(result);
      const ruta = result.routes[0];
      const distanciaMetros = ruta.legs[0].distance.value;
      window.distanciaKm = distanciaMetros / 1000;
      document.getElementById("distanciaRuta").textContent = `Distancia de la ruta: ${window.distanciaKm.toFixed(1)} km`;
      actualizarPrecio();
    } else {
      // Fallback: distancia aprox. en l√≠nea recta
      const a = originMarker.getPosition();
      const b = destinationMarker.getPosition();
      const straight = google.maps.geometry.spherical.computeDistanceBetween(a, b) / 1000;
      window.distanciaKm = straight;
      document.getElementById("distanciaRuta").textContent = `Distancia (aprox.): ${window.distanciaKm.toFixed(1)} km`;
      actualizarPrecio();
    }
  });
}

function resetRuta(){
  if (originMarker) originMarker.setMap(null);
  if (destinationMarker) destinationMarker.setMap(null);
  originMarker = null; destinationMarker = null;
  directionsRenderer.setDirections({ routes: [] });
  document.getElementById("origen").value = "";
  document.getElementById("destino").value = "";
  window.distanciaKm = 0;
  document.getElementById("distanciaRuta").textContent = "Distancia de la ruta: 0.0 km";
  actualizarPrecio();
}

/* ===== UTILIDADES OPCIONES ===== */
function isChecked(substr){
  substr = (substr||"").toLowerCase();
  return Array.from(document.querySelectorAll('.option')).some(op=>{
    const n=(op.dataset.name||"").toLowerCase();
    return op.checked && n.includes(substr);
  });
}

/* 
  L√≥gica del nivel:
  - Mudanza completa > mudanza peque√±a > (porte + carga) > porte
  - Si el usuario marca SOLO "Carga y descarga adicional", lo tratamos como "Porte + C/D".
*/
function getTier(){
  const porte     = isChecked('porte local');
  const carga     = isChecked('carga y descarga');
  const mudPeq    = isChecked('mudanza peque√±a');
  const mudComp   = isChecked('mudanza completa');

  if (mudComp) return 'mudanza_comp';
  if (mudPeq)   return 'mudanza_peq';
  if (carga && !porte) return 'porte_cyd'; // üëà Fix: carga sola implica porte+c/d
  if (porte && carga) return 'porte_cyd';
  if (porte)    return 'porte';
  return null;
}

/* ===== PESO Y PE√ìN ===== */
function calcularPeso() {
  const n = id => parseInt(document.getElementById(id)?.value) || 0;
  const manual = parseInt(document.getElementById('pesoManual')?.value) || 0;
  if (manual > 0) return manual;
  return n('armarios')*60 + n('cajas')*15 + n('bultos')*20 + n('sofas')*50 + n('camaMatrimonio')*80 + n('camaIndividual')*50;
}
function recargoPorPeso(peso, tier){
  // SOLO aplica si hay C/D o mudanza (porte solo NO suma por peso)
  if (!(tier==='porte_cyd' || tier==='mudanza_peq' || tier==='mudanza_comp')) return 0;
  if (peso <= 200) return 0;
  if (peso <= 500) return 20;
  if (peso <= 800) return 40;
  return 60;
}
function peonPorObjetos(tier){
  if (!(tier==='porte_cyd' || tier==='mudanza_peq' || tier==='mudanza_comp')) return 0;
  const n = id => parseInt(document.getElementById(id)?.value) || 0;
  const dosPersonas = n('sofas') + n('armarios') + n('camaMatrimonio');
  if (dosPersonas >= 2) return 50;
  if (dosPersonas >= 1) return 25;
  return 0;
}

/* ===== PRECIO TOTAL ===== */
function actualizarPrecio() {
  const tier = getTier();
  const peso = calcularPeso();

  // Base por nivel (no sumamos niveles entre s√≠)
  let base = 0;
  if (tier) base = BASES[tier];

  // Extras (vaciados/pintura) s√≠ suman
  let extras = 0;
  document.querySelectorAll('.option').forEach(op=>{
    if (!op.checked) return;
    const name = (op.dataset.name||"").toLowerCase();
    const isTier = name.includes('porte local') || name.includes('carga y descarga') || name.includes('mudanza peque√±a') || name.includes('mudanza completa');
    if (!isTier) extras += parseFloat(op.dataset.price) || 0;
  });

  // Km
  let kmRate = 1.2, ambasDentro = false;
  if (originMarker && destinationMarker) {
    const dentroA = insideSevilla(originMarker.getPosition());
    const dentroB = insideSevilla(destinationMarker.getPosition());
    ambasDentro = dentroA && dentroB;
    if (ambasDentro) kmRate = 0.9;
  }
  const kmCost = (window.distanciaKm>0) ? window.distanciaKm*kmRate : 0;

  // Peso (solo si C/D o mudanza)
  const pesoCost = recargoPorPeso(peso, tier);

  // Pe√≥n seg√∫n objetos (y refuerzo si much√≠simo peso)
  let peonAuto = peonPorObjetos(tier);
  if (tier && peso >= 650) peonAuto += 25;

  let total = base + extras + kmCost + pesoCost + peonAuto;

  // M√≠nimo en Sevilla capital si hay nivel seleccionado
  if (tier && ambasDentro && total < 35) total = 35;

  // UI
  const pesoEl = document.getElementById("pesoTotal");
  if (pesoEl) pesoEl.textContent = `Peso estimado: ${peso} kg`;
  const precioEl = document.getElementById("precioTotal");
  if (precioEl) precioEl.textContent = `Precio estimado: ${total.toFixed(2)} ‚Ç¨`;
  const desg = document.getElementById("desglose");
  if (desg) {
    const tierTxt = tier ? ({
      'porte':'PORTE',
      'porte_cyd':'PORTE + C/D',
      'mudanza_peq':'MUDANZA PEQUE√ëA',
      'mudanza_comp':'MUDANZA COMPLETA'
    }[tier]) : 'SIN NIVEL';
    const partes = [
      `Nivel: ${tierTxt} (${base.toFixed(2)} ‚Ç¨)`,
      `Extras: ${extras.toFixed(2)} ‚Ç¨`,
      `Km (${kmRate.toFixed(1)} ‚Ç¨/km): ${kmCost.toFixed(2)} ‚Ç¨`,
    ];
    if (pesoCost>0) partes.push(`Peso: ${pesoCost.toFixed(2)} ‚Ç¨`);
    if (peonAuto>0) partes.push(`Pe√≥n: ${peonAuto.toFixed(2)} ‚Ç¨`);
    if (ambasDentro) partes.push(`Tarifa Sevilla capital`);
    desg.textContent = partes.join(" ¬∑ ");
  }
}

/* ===== ENV√çO WHATSAPP + MODAL ===== */
function enviarSolicitud() {
  const nombre = document.getElementById('nombre')?.value.trim();
  const telefono = document.getElementById('telefono')?.value.trim();
  const origen = document.getElementById('origen')?.value.trim();
  const destino = document.getElementById('destino')?.value.trim();
  const notas = document.getElementById('notas')?.value.trim();

  if (!nombre || !telefono || !origen || !destino) {
    alert("Por favor, completa nombre, WhatsApp, origen y destino.");
    return;
  }
  const precio = document.getElementById('precioTotal')?.textContent || '';
  const peso = document.getElementById('pesoTotal')?.textContent || '';
  const distancia = document.getElementById('distanciaRuta')?.textContent || '';

  let mensaje = `Presupuesto pedido por ${nombre}%0A`;
  mensaje += `Tel√©fono: ${telefono}%0A`;
  mensaje += `Origen: ${origen}%0ADestino: ${destino}%0A`;
  mensaje += `${distancia}%0A${peso}%0A${precio}%0A`;
  mensaje += `Notas: ${notas || 'Ninguna'}%0A`;

  const numeroWhatsApp = '34698373471';
  const urlWhatsapp = `https://wa.me/${numeroWhatsApp}?text=${mensaje}`;
  window.open(urlWhatsapp, '_blank');

  abrirModal();
}

function abrirModal(){ const m=document.getElementById('modal'); if(!m) return; m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function cerrarModal(){ const m=document.getElementById('modal'); if(!m) return; m.style.display='none'; m.setAttribute('aria-hidden','true'); }
document.addEventListener('keydown', e=>{ if(e.key==='Escape') cerrarModal(); });
document.addEventListener('click', e=>{ const m=document.getElementById('modal'); if(!m||m.style.display==='none') return; if(e.target===m) cerrarModal(); });
</script>
